<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example: Mtp Controlengine &mdash; ControlEngine.Native 3.6.0-master.20240813092604+33b462c4 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/semodia_favicon_light.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=bc0274a9"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Testing ControlEngines" href="../writing_ce_tests.html" />
    <link rel="prev" title="CENA DEMO: Run the example" href="run_simulation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ControlEngine.Native
              <img src="../../../_static/semodia_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.6.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">CENA Handbook:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../00_general/index.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../10_getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">MTP &amp; MTP ControlEngines</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../mtp_model_elements.html">MTP Model Elements</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">CENA DEMO</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="cena_example_intro.html">Welcome to the CENA DEMO</a></li>
<li class="toctree-l4"><a class="reference internal" href="run_simulation.html">CENA DEMO: Run the example</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Example: Mtp Controlengine</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../writing_ce_tests.html">Testing ControlEngines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../writing_ce_tests.html#testing-services">Testing Services</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../logging/index.html">CENAs Logging Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../statemachines/index.html">CENAs State Machine API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_tasks.html">Example: Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_util_computedValues.html">Example: Util ComputedValues</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ControlEngine.Native</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Tutorials</a></li>
          <li class="breadcrumb-item"><a href="../index.html">MTP &amp; MTP ControlEngines</a></li>
          <li class="breadcrumb-item"><a href="index.html">CENA DEMO</a></li>
      <li class="breadcrumb-item active">Example: Mtp Controlengine</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/20_tutorials/mtp_controlengine/mtp_example_demo/example_mtp_controlengine.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-mtp-controlengine">
<span id="id1"></span><h1>Example: Mtp Controlengine<a class="headerlink" href="#example-mtp-controlengine" title="Link to this heading"></a></h1>
<p>This example introduces you to the basic ControlEngine design pattern that will allow your MTP CE to interact with a process.</p>
<section id="overview">
<span id="detailed-docu"></span><h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>Semodia tends to write a lot of MTP <em>control engines</em> (<em>CE</em> for brevity). After trying several approaches, an
architectural software design pattern that was SOLID, easy to replicate and robust was established. This “CE pattern”
looks like this:</p>
<p class="plantuml">
<img src="../../../_images/plantuml-6bb336417c4047953ec313f1c71e83661266f91e.png" alt="&#64;startuml
    set namespaceSeparator ::

    namespace controlengine::native {
        interface ITask {
            #start()
            #iterate()
            #stop()
        }
        abstract MtpControlEngine
    }

    class ControlEngine implements controlengine::native::ITask
    class ControlEngine extends controlengine::native::MtpControlEngine
    {
        mtp : mtp::ModuleTypePackage
        server : reflection::opcua::server
        globalDataAssembly : any mtp::DataAssembly
        ..
        + initializeMtpContents();
        + update();
    }

    class ProcessController implements controlengine::native::ITask
    {
        drivers : dataio
        --
        +openValve(bool)
        +isValveOpen() : bool
    }

    interface IServiceHandler
    {
        + initializeMtpContents(mtp);
        + update();
    }

    class ServiceHandler implements IServiceHandler
    {
        serviceParameter : any mtp::ServiceParameters
        parameter : any mtp::ProcedureParameters
        executing() : ProcedureCallback
        starting() : ProcedureCallback
        completing() : ProcedureCallback
    }

    ControlEngine &quot;1&quot; -- &quot;n&quot; ServiceHandler : &gt; owns

    ProcessController -- IServiceHandler : &lt; uses
    ProcessController -- ControlEngine   : &lt; uses
&#64;enduml"/>
</p>
<p>Let’s review the main components before we move on:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The <em>ControlEngine</em> handles everything MTP related, such as updating the MTP, updating DataAssemblies or updating services. This is where MTP-code happens!
The <em>ControlEngine</em> owns the OPC UA server instance and the MTP instance. An abstract class parent will handle any routine stuff, like reflection.</p></li>
<li><p><em>ServiceHandlers</em> bundle all resources (parameters, callbacks) that are required by service and procedure callbacks.
Whenever a MTP procedure does something, the callback can access all resources that are in the service handler.</p></li>
<li><p>The <em>ProcessController</em> will implement any driver and I/O related code. It is shared with the CE and the ServiceHandlers, so anyone can use the ProcessController to request I/O Operations.
The <em>ProcessController</em> should provide an interface that is geared towards the service requirements, so we would suggest you start your implementation with the CE and Handlers and leave this class for last.</p></li>
</ol>
</div></blockquote>
<section id="example-application">
<h3>Example application<a class="headerlink" href="#example-application" title="Link to this heading"></a></h3>
<p>It’s easier to picture what a CE does if we have an application - don’t worry, we’ll keep it simple:</p>
<ul class="simple">
<li><p>Our example application will “simulate” a tank with two binary valves (input and output) and an analog level sensor.</p></li>
<li><p>One valve will allow 1 unit of water to enter the tank per unit of time, the other will drain 1 unit of water per time.</p></li>
</ul>
<img alt="../../../_images/ditaa-f8c07325bed9fd9eb0c885c36a4de65d023354f1.png" src="../../../_images/ditaa-f8c07325bed9fd9eb0c885c36a4de65d023354f1.png" />
<p>Our process will also have a general “fault” signal, generated by a fictitious underlying controller, to indicate
stuff like leakages or stuck valves. Our service should not start as long as this signal is present.</p>
<p>Our MTP CE should:</p>
<blockquote>
<div><ul class="simple">
<li><p>Use an AnaView to show the level sensor in % of tank capacity - 0 is empty, 100 is full.</p></li>
<li><dl class="simple">
<dt>Use <strong>one service</strong> “FillTankService” with <strong>one procedure</strong></dt><dd><ul>
<li><p><strong>A BinServParam as ProcedureParameter</strong> defines if we fill or drain the tank</p></li>
<li><p>The procedure has to <strong>ProcessValueOuts - two BinViews</strong> that reflect the input and output valves</p></li>
<li><p>The procedure auto-completes when the tank level indicates full or empty</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>Here’s a definition table for our MTP - this is what you will usually either get from the client or have derived
with your process experts:</p>
<blockquote>
<div></div></blockquote>
<table class="docutils align-default" id="mtp-definition-table">
<tbody>
<tr class="row-odd"><td colspan="2"><p>Service:</p></td>
<td colspan="2"><p>FillTankService</p></td>
</tr>
<tr class="row-even"><td colspan="2"><p>Service Parameters:</p></td>
<td colspan="2"></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>Procedures:</p></td>
<td><p>1:LiquidProcedure</p></td>
<td><p>2:WeDontHaveAnotherProcedure</p></td>
</tr>
<tr class="row-even"><td colspan="2"><p>Procedure Parameters:</p></td>
<td><ul class="simple">
<li><p>Fill/~Drain (BinServParam)</p></li>
</ul>
</td>
<td></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>Process Input Values:</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td colspan="2"><p>Process Output Values:</p></td>
<td><ul class="simple">
<li><p>InletOpen (BinView)</p></li>
<li><p>OutletOpen (BinView)</p></li>
</ul>
</td>
<td></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>Report Values:</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td colspan="2"><p>EXECUTE self-completing:</p></td>
<td><p>yes</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>State</p></td>
<td><p>Transition</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>IDLE</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>START</p></td>
<td><p>no fault indicated</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>STARTING</p></td>
<td><p>sc</p></td>
<td><dl class="simple">
<dt>do:</dt><dd><p>Close Outlet
Open Inlet</p>
</dd>
<dt>then:</dt><dd><p>complete</p>
</dd>
</dl>
</td>
<td></td>
</tr>
<tr class="row-odd"><td><p>EXECUTING</p></td>
<td></td>
<td><dl class="simple">
<dt>if (failure):</dt><dd><p>goto HOLDING</p>
</dd>
<dt>else if(level != target):</dt><dd><p>do nothing</p>
</dd>
<dt>else:</dt><dd><p>complete</p>
</dd>
</dl>
</td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td><p>COMPLETE</p></td>
<td><p>n/a</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>COMPLETING</p></td>
<td><p>sc</p></td>
<td><dl class="simple">
<dt>do:</dt><dd><p>Close Outlet
Close Inlet</p>
</dd>
</dl>
<p>complete</p>
</td>
<td></td>
</tr>
<tr class="row-even"><td><p>COMPLETED</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>PAUSE</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>PAUSING</p></td>
<td><p>sc</p></td>
<td><p>like COMPLETING</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>PAUSED</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td><p>RESUME</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>RESUMING</p></td>
<td></td>
<td><p>like STARTING</p></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td><p>HOLD</p></td>
<td><p>fault indicated</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>HOLDING</p></td>
<td><p>sc</p></td>
<td><p>like COMPLETING</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>HELD</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>UNHOLD</p></td>
<td><p>no fault indicated</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>UNHOLDING</p></td>
<td></td>
<td><p>like STARTING</p></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>STOP</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>STOPPING</p></td>
<td><p>sc</p></td>
<td><p>like COMPLETING</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>STOPPED</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td><p>ABORT</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>ABORTING</p></td>
<td><p>sc</p></td>
<td><p>like COMPLETING</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>ABORTED</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>RESET</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>RESETTING</p></td>
<td><p>sc</p></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><em>Table: Methodic listing of the a MTP service behavior with pseudo-code. For transitions, the description states when the transition is enabled. For states, it describes how they interact with the process</em></p>
</div></blockquote>
<p>Note that this MTP is of course entirely constructed for this example; we might just as well have used two separate
procedures for filling/draining instead of the parameter… or even two services… or a level control parameter…</p>
<p>This example was built to demonstrate</p>
<ol class="arabic simple">
<li><p>How to create services with procedure callbacks</p></li>
<li><p>How to insert Procedure or Service parameters</p></li>
<li><p>How to exert control over your process</p></li>
<li><p>How to update parameters to/from the process as required</p></li>
</ol>
<p>For a better understanding you might want to <a class="reference internal" href="#run-the-ce"><span class="std std-ref">check out the simulation</span></a> before getting deeper into the documentation, as you will see the desired outcome.</p>
</section>
<section id="software-prework">
<h3>Software PreWork<a class="headerlink" href="#software-prework" title="Link to this heading"></a></h3>
<p>Before we dive into our actual CE, let’s start of with some fundamental includes and infrastructure.</p>
<p>We will be using some terminal I/O, so we will create some rudimentary (and quite local to this example (‘static’)) IO functions first.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>CENA has a logging API</p>
<p>This is a quick-and-dirty solution so we don’t need to explain our CENA logging API…
In a real application, we would use the CENA logging API.</p>
</div>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">debug</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;DEBUG&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;INFO &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;ERROR&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>First of, take care of signal handlers so we can CTRL-C out of our application.
Note the extern-C - these are C headers and we don’t want the C++ compiler to name-mangle their definitions.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span>
<span class="p">{</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;signal.h&gt;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <cite>run</cite> variable (limited to this file) will control our main loop &amp; allows the signal handler to
terminate our program.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stopHandler</span><span class="p">([[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sign</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="the-process-controller">
<h2>The Process Controller<a class="headerlink" href="#the-process-controller" title="Link to this heading"></a></h2>
<p>In this example, we will create the ProcessController first - it’s a dummy class with no real functionality.</p>
<section id="the-processcontroller-interface">
<h3>The ProcessController Interface<a class="headerlink" href="#the-processcontroller-interface" title="Link to this heading"></a></h3>
<p>The following interface specifies what our CE will need to see to interact with the process.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IProcessController</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">IProcessController</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">IProcessController</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
</pre></div>
</div>
<p>We need to evaluate the underlying controllers fault signal to find out if it is safe to use our tank… return <cite>true</cite> if a fault is detected, <cite>false</cite> otherwise</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isFaultPresent</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>Allow the process controller to open/close our valve (inlet)</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setInletValveOpen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>Allow the process controller to open/close our valve (outlet)</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setOutletValveOpen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>To feed our BinView ReportValue, the CE needs to know the status of the inlet valve</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isInletValveOpen</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>To feed our other BinView ReportValue, the CE needs to know the status of the outlet valve</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isOutletValveOpen</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>To feed our AnaView, the CE needs to know the level status of the tank in %</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getFillLevelInPercent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<section id="high-and-low-level-control">
<h4>High- and Low level control<a class="headerlink" href="#high-and-low-level-control" title="Link to this heading"></a></h4>
<p id="index-0">The process control approach shown here allows the services to state how they want the process to act. The service
must now specify all the control details about what valve to open/close and when. This is <em>low-level control</em> in the service.</p>
<p>That is ok, but there’s an alternate approach.</p>
<p>You might simplify services considerably by just stating that “a service
fills the tank and is done when tank is full”. <cite>IProcessController</cite> would have three key functions:
<code class="docutils literal notranslate"><span class="pre">fillTank()</span></code> and <code class="docutils literal notranslate"><span class="pre">drainTank()</span></code>, as well as <code class="docutils literal notranslate"><span class="pre">operationComplete()</span></code>.</p>
<p>These would handle low-level control (which valves to open when), while the CE handles High-Level control.
The <cite>ProcessController</cite> could be tested to assure it does indeed fill and drain as expected. This approach is more
in accord with the Single Responsibility Principle, i.e. the <cite>ProcessController</cite> actually controlling the process as
opposed to <cite>ValveControllerWithFillLevelMetering</cite>…</p>
<p>Which approach you choose is up to you.</p>
</section>
</section>
<section id="the-processcontroller-process-simulator">
<h3>The ProcessController / Process Simulator<a class="headerlink" href="#the-processcontroller-process-simulator" title="Link to this heading"></a></h3>
<p>In terms of “process simulation”, we will use <code class="docutils literal notranslate"><span class="pre">std::chrono</span></code> to simulate how much liquid flows into our tank per unit of time</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
</pre></div>
</div>
<p>Also, this is the first time we encounter our task API; it is explained in detail in another tutorial.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;tasking/BasicTaskLoopTask.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;locking/Lock.hpp&quot;</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">cena</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">semodia</span><span class="o">::</span><span class="nn">controlengine</span><span class="o">::</span><span class="nn">native</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">tasking</span><span class="o">::</span><span class="n">BasicTaskLoopTask</span><span class="p">;</span>
</pre></div>
</div>
<p>The process controller itself doubles as a rudimentary process simulator.</p>
<p>In a real application, the ProcessController decouples CE and process. When executed by a thread or “iterated”</p>
<p>in a task loop, it should</p>
<ul class="simple">
<li><p>Update any parts of the process modified by the CENA (ProcessController –&gt; Drivers)</p></li>
<li><p>Update any internal representation of the process state (ProcessController &lt;– Drivers)</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Blocking IO</p>
<p>Unless it is trivial, never let any IProcessController interface function block or wait for a driver.
This would stall the CE and any communications associated with it. Compared to OPC UA, most process
interfaces are really, really slow.</p>
</div>
<p>We don’t have a real process to control or get data from.
But we can simply use Chrono and some magic to simulate filling and draining our tank.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Improved testing</p>
<p>The CE won’t know that the process is real or not - from the CE’s standpoint, this could equally well be
the real deal! This makes testing CE’s in this pattern a delight, as your tests can control a MockProcessController
to check up on the CE’s actions.</p>
</div>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProcessController</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IProcessController</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BasicTaskLoopTask</span>
<span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
</pre></div>
</div>
<p>The <cite>tankCapacity</cite> attribute represent units of liquid we can hold</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tankCapacity</span><span class="p">;</span>
</pre></div>
</div>
<p>The <cite>tankContents</cite> variable defines how much fluid is in the tank at this time</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="n">tankContents</span><span class="p">;</span>
</pre></div>
</div>
<p>The <cite>flowrate</cite> states how much liquid can enter or leave our virtual tank per second.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">flowRate</span><span class="p">;</span><span class="w"> </span><span class="c1">// in liquid units/second</span>
</pre></div>
</div>
<p>Create a rudimentary model of our input/output values: <cite>true</cite> is open, <cite>false</cite> is closed</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="n">inletValveOpen</span><span class="p">;</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">outletValveOpen</span><span class="p">;</span>
</pre></div>
</div>
<p>We know our fill rate in units/second… record when <code class="docutils literal notranslate"><span class="pre">iterate()</span></code> was last called to determine how much liquid entered or left our tank</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="w"> </span><span class="n">lastUpdate</span><span class="p">;</span>
</pre></div>
</div>
<p>We also create a helper function to convert our timestamp to seconds (so we can hide chrono)</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="nf">getMicroSecondsElapsedSinceLastUpdate</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">().</span><span class="n">time_since_epoch</span><span class="p">())</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastUpdate</span><span class="p">).</span><span class="n">count</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And let’s use another helper function to update our timestamp</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">markLastUpdateNow</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">lastUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">().</span><span class="n">time_since_epoch</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="k">protected</span><span class="o">:</span>
</pre></div>
</div>
<p>Our iteration function (part of our task) is where we would usually update drivers with our process image</p>
<p>and read back values from the drivers into our process image. We’ll just “simulate” :)</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">iterate</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Get the time perioid that passed since the last iteration</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getMicroSecondsElapsedSinceLastUpdate</span><span class="p">();</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000000.f</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Fill and/or drain. Yes. We can do both. We are THAT GOOD!</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">inletValveOpen</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">flowRate</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seconds</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">outletValveOpen</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">flowRate</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seconds</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Prevent overfilling and underdraining:</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankCapacity</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankCapacity</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Update the timestamp</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">markLastUpdateNow</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
</pre></div>
</div>
<p>In terms of initialization of our ProcessController, the capacity and flow rate are considered</p>
<p>“structural parameters” and are constants. We shall always initialize an empty vessel with closed valves.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ProcessController</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">tankCapacity</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">flowRate</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w">   </span><span class="n">IProcessController</span><span class="p">(),</span>
<span class="w">        </span><span class="n">BasicTaskLoopTask</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">locking</span><span class="o">::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">()),</span>
<span class="w">        </span><span class="n">tankCapacity</span><span class="p">(</span><span class="n">tankCapacity</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tankCapacity</span><span class="p">),</span>
<span class="w">        </span><span class="n">tankContents</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="n">flowRate</span><span class="p">(</span><span class="n">flowRate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">flowRate</span><span class="p">),</span>
<span class="w">        </span><span class="n">inletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
<span class="w">        </span><span class="n">outletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">markLastUpdateNow</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ProcessController</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is usually a very, very bad idea to copy a process controller with all its stateful drivers. This might</p>
<p>result in drivers being instructed to do things multiple times or in contradicting ways… we suggest you
prevent copies of ProcessControllers.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ProcessController</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ProcessController</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span>
<span class="n">ProcessController</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ProcessController</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span>
</pre></div>
</div>
<p>The required interface functions should be fairly straight-forward at this point:</p>
<p>We don’t really have any fault-ability right now… this is solely here to show you</p>
<p>how to go from EXECUTE to HOLD on an error. Take a look at <a class="reference internal" href="#mtp-ce-gotoholdonerror"><span class="std std-ref">automatically going to HOLD on an error</span></a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">isFaultPresent</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The input parameter/value of <cite>setInletValveOpen()</cite> is copied to our internal boolean</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setInletValveOpen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">&amp;</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="k">override</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The input parameter/value of <cite>setOutletValveOpen()</cite> is also just copied to our internal boolean</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setOutletValveOpen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">&amp;</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="k">override</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The inlet valve state is simply a copy of our own internal boolean; a real ProcessController might however</p>
<p>have a valve with separate feedback. In that case we would read the feedback in <cite>ProcessController::iterate()</cite> so that
we not had to include any blocking IO here.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isInletValveOpen</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveOpen</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The outlet valve state is simply a copy our own internal boolean; a real ProcessController might however</p>
<p>have a valve with separate feedback.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isOutletValveOpen</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveOpen</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The tank fill level in percent is easy to calculate from our current contents and capacity</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getFillLevelInPercent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">100.f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="o">/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankCapacity</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Multi-Service can mean Multi-Threading!</p>
<p>In a real-world application, multiple services will share a ProcessController. Simultaneous access might
wreak havoc on your drivers. We highly suggest you introduce the cena::osal::ILockable class to your
<cite>ProcessController</cite> to provide thread safety.</p>
</div>
</section>
</section>
<section id="the-service-handler">
<h2>The Service Handler<a class="headerlink" href="#the-service-handler" title="Link to this heading"></a></h2>
<p>Before we get to the CE, we need ServiceHandlers.</p>
<p>ServiceHandlers contain all MTP parameters, ReportValues, ProcessValueIns and ProcessValuesOuts that a service
needs. They also house any callbacks and they initialize the MTP’s service representation.</p>
<p>This obviously means that this is the point where we need to introduce the MTP SDK to our example:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ModuleTypePackage.hpp&quot;</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">mtp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">cena</span><span class="o">::</span><span class="nn">model</span><span class="o">::</span><span class="nn">mtp</span><span class="p">;</span>
</pre></div>
</div>
<section id="service-handler-interface">
<h3>Service Handler Interface<a class="headerlink" href="#service-handler-interface" title="Link to this heading"></a></h3>
<p>This Interface is used by the ControlEngine class to interact with service handlers that hold service and procedure parameters</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IServiceHandler</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">IServiceHandler</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">IServiceHandler</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
</pre></div>
</div>
<p>Invoked by ControlEngine as part of regular iteration; may include reading/updating Report- or ProcessOut values</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p><cite>initializeMtpContents</cite> is invoked by ControlEngine to set up any mtp related contents, such as service parameters or nodeIds.</p>
<p>This removes the need to initialize the service directly in the CE.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeMtpContents</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ModuleTypePackage</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mtp</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="filltankservicehandler">
<h3>FillTankServiceHandler<a class="headerlink" href="#filltankservicehandler" title="Link to this heading"></a></h3>
<p>Let’s dive into our actual service handler and begin by including what we will need from CENA MTP Model Core:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/BinView.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/BinServParam.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/Service.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ServiceSet.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ServiceControl.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/Procedure.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ServiceSourceModeBaseFunction.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ServiceOperationModeBaseFunction.hpp&quot;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">mtp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">semodia</span><span class="o">::</span><span class="nn">controlengine</span><span class="o">::</span><span class="nn">native</span><span class="o">::</span><span class="nn">model</span><span class="o">::</span><span class="nn">mtp</span><span class="p">;</span>
</pre></div>
</div>
<p>We could solve this more elegantly, but just for this example lets declare our namespace globally to be
consistent in CE and Service Handlers.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">(</span><span class="s">&quot;https://yourNamespace.com&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The FillTankServiceHandler class will have to handle everything related to the service.</p>
<p>“Everything related” includes:</p>
<ul class="simple">
<li><p>Owning all parameters, processes in/outs and reports values</p></li>
<li><p>Configuring the service in the mtp</p></li>
<li><p>Owning all callbacks, i.e. business logic included in the MTP’s states</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FillTankServiceHandler</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IServiceHandler</span>
<span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
</pre></div>
</div>
<p>to simplify access to the mtp::Service class, we will store a pointer to the service while initializing the MTP</p>
<p>Note how everything in this class is shared?</p>
<blockquote>
<div><p>One pointer instance always resides in the MTP, but a second instance is kept in the handlers for convenience.
Alternatively, we could - if we wanted to - also “retrieve” these classes from the MTP on each use.</p>
</div></blockquote>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">Service</span><span class="o">&gt;</span><span class="w"> </span><span class="n">liquidService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>
</pre></div>
</div>
<p>Remember how we said “The ServiceHandler owns the parameters”?
Here they are:</p>
<p>The ProcedureParameter that instructs us to fill or drain the tank when going into the “starting” state of our service</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinServParam</span><span class="o">&gt;</span><span class="w"> </span><span class="n">procedureModeFillTank</span><span class="p">;</span>
</pre></div>
</div>
<p>The inlet valve state (ProcessValueOut) as reported by the process controller; updated by <cite>FillTankServiceHandler::update()</cite></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inletValveState</span><span class="p">;</span>
</pre></div>
</div>
<p>The outlet valve state (ProcessValueOut) as reported by the process controller; updated by <cite>FillTankServiceHandler::update()</cite></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outletValveState</span><span class="p">;</span>
</pre></div>
</div>
<p>If you had any ServiceConfigurationParameters, ReportValues or ProcessValueIns, they would also be declared right here.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Why not declare all Data Assemblies in the CE and share them around?</p>
<p>From the CE and Handler standpoint, it does not matter where the instances reside. But the ServiceHandler <strong>must</strong>
access them, while the CE has no use for the parameters. Placing unneeded DataAssemblies in the CE/InstanceList
(instead of in the services) and then sharing them around reduced the memory footprint by allowing reuse, but
increases software complexity.</p>
</div>
<p>This is the process controller that this class needs to interact with the CE and all other service handlers</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
</pre></div>
</div>
<p>We need to initialize our member parameters in the constructor.</p>
<p>For convenience, we will sync our BinServParam to the state; i.e. we don’t have to control offline/automatic/manual and external/internal - they are copied from the service</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">FillTankServiceHandler</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w">   </span><span class="n">procedureModeFillTank</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinServParam</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;fillTank&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Instruction to fill or drain the tank&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;True means fill&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;False means drain&quot;</span><span class="p">)),</span>
<span class="w">        </span><span class="n">inletValveState</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinView</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;inletValveState&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Valve controlling liquid going into the tank&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;True means open&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;False means closed&quot;</span><span class="p">)),</span>
<span class="w">        </span><span class="n">outletValveState</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinView</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;outletValveState&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Valve controlling liquid going into the tank&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;True means open&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;False means closed&quot;</span><span class="p">)),</span>
<span class="w">        </span><span class="n">process</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">FillTankServiceHandler</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="initializing-the-mtp">
<h4>Initializing the MTP<a class="headerlink" href="#initializing-the-mtp" title="Link to this heading"></a></h4>
<p>We need to initialize the MTP to include our service. To that end, we need to create the service and service
control stuff in the MTP, then include pointers to our parameters.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeMtpContents</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ModuleTypePackage</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mtp</span><span class="p">)</span><span class="w"> </span><span class="k">override</span>
<span class="p">{</span>
</pre></div>
</div>
<p>Before we start with the service, let’s assign some static nodeIds to our parameters; these need to match
the parameters as defined in the MTP so the POL can address them directly using OPC UA.</p>
<p>You can assign parameters to any ReadDataItem or ReadWriteDataItem in the MTP Model Core like so:
(yes, you may also use ‘i=’)</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="o">-&gt;</span><span class="n">getV</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=InletValveState_V&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="o">-&gt;</span><span class="n">getWQC</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=InletValveState_WQC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="o">-&gt;</span><span class="n">getV</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=OutletValveState_V&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="o">-&gt;</span><span class="n">getWQC</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=OutletValveState_WQC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVOut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VOut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVReq</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VReq&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyEn</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_ApplyEn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_ApplyOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_ApplyExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_ApplyIn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
</pre></div>
</div>
<p>Next, we need to create and configure our service in the mtp, populate each service and attach our parameters.</p>
<p>Take your <a class="reference internal" href="#mtp-definition-table"><span class="std std-ref">MTP Definition Table</span></a> as a reference and stick to this template:</p>
<p>For each service, do:</p>
<blockquote>
<div><ul class="simple">
<li><p>create the service</p></li>
<li><p>add any service configuration parameters</p></li>
<li><p>For each procedure:</p>
<ul>
<li><p>Create the procedure</p></li>
<li><p>Add parameters</p></li>
<li><p>Assign static nodeIds to procedure elements (as defined in the MTP file)</p></li>
</ul>
</li>
<li><p>Assign static nodeIds to service control elements (as defined in the MTP file)</p></li>
</ul>
</div></blockquote>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">mtp</span><span class="p">.</span><span class="n">getControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">createService</span><span class="p">(</span><span class="s">&quot;FillTankService&quot;</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mtp</span><span class="p">.</span><span class="n">getControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceByName</span><span class="p">(</span><span class="s">&quot;FillTankService&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">liquidService</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Created FillTankService&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>If this service had <cite>ConfigurationParameters</cite>, this would be the place to put them. These parameters
would be considered “shared” amongst all procedures.</p>
<p>We have a <cite>ProcedureParameter</cite> further down, which works in exactly the same way as the
<cite>ConfigurationParameters</cite> would.</p>
<p>Let’s continue by creating our procedure.</p>
<p>A procedure is represented by an ID, which the POL uses to select and with 0 meaning “no procedure”.
We don’t assign this ID from userspace; it is assigned incrementally by the stack.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">procedureIdAssignedByService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">createProcedure</span><span class="p">(</span><span class="s">&quot;FillTank&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w">  </span><span class="n">procedureIdAssignedByService</span><span class="p">,</span>
<span class="w">     </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">mtp</span><span class="o">::</span><span class="n">ProcedureHealthView</span><span class="o">&amp;</span><span class="w"> </span><span class="n">commandInfo</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
</pre></div>
</div>
<p id="index-1">Procedures determine which transitions within a service are permitted, which they do by updating
their <cite>CommandInfo</cite>. We have to define which transitions are permitted, an when. Note that all procedures
always update this value, even if they are not selected by the POL or running.</p>
<p>The default - if we don’t change anything here - is to allow all transitions.</p>
<p>We want to update which states the POL can request. In our <a class="reference internal" href="#mtp-definition-table"><span class="std std-ref">MTP Definition Table</span></a>, there
is only one major switch: Fault or not fault.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">COMPLETE</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">ABORT</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">HOLD</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">STOP</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">RESET</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isFaultPresent</span><span class="p">()));</span>
<span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">HOLD</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isFaultPresent</span><span class="p">());</span>
<span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">UNHOLD</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isFaultPresent</span><span class="p">()));</span>
</pre></div>
</div>
<p>For this example, we will also interdict the use of PAUSE and RESTART, like so:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">        </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">RESTART</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">        </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">PAUSE</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>If your MTP has a fixed ID for this procedure, it pays off to check this procedure here</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">procedureIdAssignedByService</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;We expected ProcedureId 1... but the CENA has assigned another ID&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Procedure fillTank (intended to be selectable using MTP procedure ID 1 and to be self-completing)</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">Procedure</span><span class="o">&gt;</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"> </span><span class="c1">// We&#39;ll need this</span>
<span class="k">if</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getProcedureByName</span><span class="p">(</span><span class="s">&quot;FillTank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Add the `ProcedureParameters` (which work exactly like `ConfigurationParameters`)</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">createProcedureParameter</span><span class="p">(</span><span class="s">&quot;FillMode&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// add ReportValues</span>
<span class="w">    </span><span class="c1">// ... if we had any, which we don&#39;t</span>

<span class="w">    </span><span class="c1">// ProcessValueOut</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">createProcessValueOut</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">createProcessValueOut</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// add ProcessValueIns</span>
<span class="w">    </span><span class="c1">// ... if we had any, which we don&#39;t</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;MTP Initialization: Creating procedure &#39;FillTank&#39; failed&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// &lt;&lt; If we had more procedures, they would go here</span>
</pre></div>
</div>
<p>Now we define the node ids for the Service, ServiceControl and ProcedureHealthView DataAssemblies.
If we don’t specify the node ids statically, they will be assigned arbitrary at runtime.
As we want them to match the node ids defined in the MTP file, we set them explicitly, otherwise the POL
could not address the nodes correctly.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateChannel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateChannel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateAutAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateAutAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOpAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOpAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOffAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOffAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOpOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOpOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateAutOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateAutOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOffOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOffOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOpAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOpAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateAutAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateAutAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOffAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOffAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandEn</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_CommandEn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_CommandOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_CommandInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_CommandExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureCur</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureCur&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateCur</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateCur&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureReq</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureReq&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcParamApplyOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyEn</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcParamApplyEn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcParamApplyInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcParamApplyExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getConfigParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ConfigParamApplyOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getConfigParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyEn</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ConfigParamApplyEn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getConfigParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ConfigParamApplyInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getConfigParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ConfigParamApplyExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getWQC</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_WQC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOSLevel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_OSLevel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPosTextID</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_PosTextID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getInteractQuestionID</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_InteractQuestionID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getInteractAnswerID</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_InteractAnswerID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getInteractAddInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_InteractAddInfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getReportValueFreeze</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ReportValueFreeze&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcChannel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcChannel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcExtAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcExtAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcIntAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcIntAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcIntOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcIntOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcExtOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcExtOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcIntAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcIntAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcExtAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcExtAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>

<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">getReferencedProcedureHealthView</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getWQC</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankHV_WQC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">getReferencedProcedureHealthView</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankHV_CommandInfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to create FillTankService&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Cool. That wasn’t too difficult.</p>
<p>We now are left some critical tasks that configure the CE’s behavior:</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>For each Service:</dt><dd><ul class="simple">
<li><p>Optional: Set up ApplyEn for each <cite>ConfigurationParameter</cite></p></li>
<li><p>Optional: Set up ApplyCallbacks for each <cite>ConfigurationParameter</cite></p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<ol class="arabic simple">
<li><dl class="simple">
<dt>For each Procedure:</dt><dd><ul class="simple">
<li><p>We need to attach our procedure callbacks</p></li>
<li><p>Optional: Set up ApplyEn for each <cite>ProcedureParameter</cite></p></li>
<li><p>Optional: Set up ApplyCallbacks for each <cite>ProcedureParameter</cite></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>We need to set the default controller (who may change offline/automatic/operator modes) of Services</p></li>
<li><p>We need to set the default controller (who may change offline/automatic/operator modes) of</p>
<ol class="arabic simple">
<li><p>service configuration parameters</p></li>
<li><p>procedure parameters</p></li>
</ol>
</li>
<li><p>If required, set sync modes and other configuration stuff for the parameters</p></li>
</ol>
<p id="index-2">Let us start with the callbacks. Note that you by no means need to attach a callback to each state - if you
leave a state out, CENA will automatically use a proxy that does nothing and always completes immediately.
You can also bind the same callback multiple times and even declare lambda operations right here. It’s up to
you.</p>
<p>Again, using the <a class="reference internal" href="#mtp-definition-table"><span class="std std-ref">MTP Definition Table</span></a> as a reference makes this easy:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">Procedure</span><span class="o">&gt;</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"> </span><span class="c1">// We&#39;ll need this</span>
<span class="k">if</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getProcedureByName</span><span class="p">(</span><span class="s">&quot;FillTank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">STARTING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">starting</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">RESUMING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">starting</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">UNHOLDING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">starting</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">EXECUTE</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">executing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">COMPLETING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">completing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">PAUSING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">completing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">HOLDING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">holding</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">STOPPING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">completing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="w">    </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">ABORTING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">completing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
</pre></div>
</div>
<p><cite>ProcedureParameters</cite> (and <cite>ConfigurationParameters</cite>) contain a single <cite>ParameterElement</cite>.</p>
<p>The POL can not change parameters whenever it likes - we have to allow Updates by settings each parameters “enable” bit.
We want the <cite>ProcedureParameter</cite> to be changeable in IDLE so we can use it in STARTING (remember: we turned RESTART of).
The “wrapper” around the actual parameter provides us with an alternative: We can automate the handling of ApplyEn
based on the service state of a selected or active procedure.</p>
<p class="plantuml">
<img src="../../../_images/plantuml-4d26cae4c1ec332b7304c7f51fa4067a9ae28b93.png" alt="&#64;startuml
class ProcedureParameter
{
    +name : string
    +ReferencesDataAssembly : *ParameterElement
}
note left of ProcedureParameter
    Provides ApplyEn automation
    tied to service states
end note

ProcedureParameter *- ParameterElement : &quot;ReferencesDataAssembly&quot;

class ParameterElement
{
    +TagName : string
    +ApplyEn : bool
    ...
}

note right of ParameterElement
    Handles Apply-Logic
    Knows nothing about which procedure
    it belongs to or what state the service
    is in
end note

class BinServParam extends ParameterElement
{
    VInt : bool
    VExt : bool
    VOp : bool
    V : bool
}

note right of BinServParam
    The actual value in the handler
    that we want to use in
    STARTING.
end note
&#64;enduml"/>
</p>
<p>Step 1: We don’t want updates to be allowed initially.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">allowValueUpdates</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</pre></div>
</div>
<p id="index-3">If you do not pass a name parameter, i.e. <cite>liquidProcedure-&gt;createProcedureParameter(this-&gt;procedureModeFillTank);</cite>,
the stack would simply use <cite>procedureModeFillTank</cite>’s TagName.</p>
<p>Using this form of ApplyEn-automation is entirely optional!
We could simply activate and deactivate this in the IDLE and STARTING callbacks…</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">ProcedureParameter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">procedureParameter</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">getProcedureParameterByName</span><span class="p">(</span><span class="s">&quot;FillMode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">procedureParameter</span><span class="p">))</span>
<span class="p">{</span>
</pre></div>
</div>
<p>To demonstrate, we will instruct the stack to automatically enable updates for the <cite>ProcedureParameter</cite> in IDLE,
but disable it when entering STARTING.</p>
<p>Note that for every state not explicitly mentioned in this callback, the ApplyEn bit remains unchanged</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">procedureParameter</span><span class="o">-&gt;</span><span class="n">setStateBasedUpdateEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">IDLE</span><span class="p">,</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">StateBasedUpdateEnableSetting</span><span class="o">::</span><span class="n">EnabledByState</span><span class="p">);</span>
<span class="w">    </span><span class="n">procedureParameter</span><span class="o">-&gt;</span><span class="n">setStateBasedUpdateEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">STARTING</span><span class="p">,</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">StateBasedUpdateEnableSetting</span><span class="o">::</span><span class="n">DisabledByState</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>One last word about <cite>ProcedureParameters</cite> and <cite>ConfigurationParameters</cite>:</p>
<p>You will find that there are two general use cases for these.</p>
<ol class="arabic simple">
<li><p>Most of the time, you will simply read and use the parameter values in the callbacks - for example to
see if a fill level of a tank is reached. For these uses the Parameter is now pretty much set up.</p></li>
<li><p>Occasianally, you will need to do something only when the parameter is changed. This tends to be
the case for parameters to send to smart field devices, like mass flow sensors. For these kinds of
uses we need to have some form of “onChange” trigger/event callback.</p></li>
</ol>
<p>Let’s quickly demonstrate the callbacks, even though we won’t use them in this example.
Note that we are passing the lamda-function its own shared_ptr-copy of our parameter,
ensuring that this callback won’t crash on the off chance it is invoked without this/handler existing anymore.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">procedureModeFillTankReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">afterApplyDo</span><span class="p">([</span><span class="n">procedureModeFillTankReference</span><span class="p">](){</span>
<span class="w">        </span><span class="n">info</span><span class="p">(</span><span class="s">&quot;The mode of filling the tank was changed to `&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">procedureModeFillTankReference</span><span class="o">-&gt;</span><span class="n">getCurrentSetpoint</span><span class="p">()))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;`&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="index-4">Next comes the default controller for our service: We should put the POL in charge (we/CENA can grab control)
whenever it feels like it, as we will see in HOLD.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">liquidService</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestModeControl</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="index-5">Finally, we will set up the parameters. For each of our parameters, this entails</p>
<ul class="simple">
<li><p>Assigning the controller (as with the service)</p></li>
<li><p>Optionally: Making the parameter sync</p></li>
</ul>
<p>Instead of controlling the parameter via the POL, we want it synced to our service control mode. This makes
the parameter be Operator-controlled when the service is operator-controller and automatic when the service is
in automatic.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">requestModeControl</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">setSync</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="updating-a-service-handler">
<h4>Updating a service Handler<a class="headerlink" href="#updating-a-service-handler" title="Link to this heading"></a></h4>
<p>We need to initialize the MTP to include our service. To that end, we need to create the service and service
control stuff in the MTP, then include pointers to our parameters.</p>
<p>Updating has 2 big parts:</p>
<ol class="arabic simple">
<li><p>Updating our parameters either by reading or writing from/to the process</p></li>
<li><p>Setting command enable bits to block/allow access to specific parts of our service’s state machine</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">update()</span></code> function updates MTP related contents periodically, i.e. it is not triggered by the</p>
<p>MTP Model Core on changes from the POL, but called as part of our task loop or thread handling the CE.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="p">{</span>
</pre></div>
</div>
<p id="index-6">Handling our parameters follows a fixed pattern:</p>
<ol class="arabic simple">
<li><p>Read all outputs from the process (ReportValues, ProcessValueOuts, potential Fbk in Service/ProcedureParameters)</p></li>
<li><p>Write any inputs to the process (ProcessValueIns)</p></li>
</ol>
<p>If you have error reporting in your process class - i.e. you get a StatusCode along with the value - you might
also want to update the WQC of each value… we don’t have that, so we’ll just set them to ‘OK’.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Note how [Bin/DInt/Ana/String]View-Types can update their VOut by assigning the appropriate type.</span>
<span class="w">        </span><span class="c1">// For ParameterElements, this would affect VFbk.</span>
<span class="w">        </span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isInletValveOpen</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="o">-&gt;</span><span class="n">setQualityCode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">QualityCode</span><span class="o">::</span><span class="n">OK</span><span class="p">);</span>

<span class="w">        </span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isOutletValveOpen</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="o">-&gt;</span><span class="n">setQualityCode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">QualityCode</span><span class="o">::</span><span class="n">OK</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// &lt;&lt; We don&#39;t have any ProcessValueIns to write to the process, but if we had some, they would go here</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="the-service-s-business-logic">
<h3>The Service’s Business logic<a class="headerlink" href="#the-service-s-business-logic" title="Link to this heading"></a></h3>
<p id="index-7">In our entire service, we only need to specify “control logic” for a handful of states. These are
rather straight forward to fill out since we have easy access to all our parameters and the process class.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Callbacks may be called asynchronously</p>
<p>The Model Core will invoke these callbacks whenever the MTP is updated and the service is in the
appropriate state - this may mean that they can be called at a point in time you don’t control.</p>
</div>
<p>Note how each callback needs to report back if it is “completed” - this is of significance for all
“sc” states and self-completing EXECUTING services, as returning <cite>true</cite> will make the internal state
machine conclude this state.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">starting</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">completed</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;FillTankServiceHandler: LiquidProcedure: Starting&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getCurrentSetpoint</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// &quot;True&quot; is &quot;fill&quot;</span>
<span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Commencing fill&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setInletValveOpen</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setOutletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// &quot;False&quot; is &quot;drain&quot;</span>
<span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Commencing drain&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setInletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setOutletValveOpen</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">executing</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">completed</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;FillTankServiceHandler: LiquidProcedure: Executing&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</pre></div>
</div>
<p>Most applications will state that they want EXECUTING to go to HOLDING when
an error occurs. This is a bit counter-intuitive from the PEAs standpoint, as we assume that the POL
is in control and - if it wants to - it can see the error and simply command us to HOLD. However, most
applications deem this either to be too uncertain or not fast enough.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Safety critical control</p>
<p>The MTP and in turn the CENA are not designed to handle safety-critical applications! Ultimately, there
would always be a controller underneath the CENA that handles interlocks, so going to HOLDING on our
part is more of a gesture than a safety related issues.</p>
</div>
<p id="mtp-ce-gotoholdonerror">In any case, to switch the command/issue own commands, we need to grab control of the service’s ServiceControl.
This will likely be in Automatic/External or even Operator. We need it to be in Automatic/Internal to
request state changes. We need to hand this control back AFTER we are done, i.e. in the HOLDING callback.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isFaultPresent</span><span class="p">())</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Declare PEA as service controller and take the service to Automatic/Internal, then issue HOLD</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestModeControl</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestOperationMode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">OperationModeId</span><span class="o">::</span><span class="n">Automatic</span><span class="p">,</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceSourceModeId</span><span class="o">::</span><span class="n">Internal</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestCommand</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">HOLD</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A common misconception in MTP definitions is that we need to “declare” all parameters we want to
use in the business logic as some form of parameter. As you see here, we don’t! We can interrogate
our process just fine using the process class, without requiring a “fill level” parameter in the
service.</p>
<p>This does indeed help to abstract the underlying process and keeps the MTP lean.</p>
</div>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">fillLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">getFillLevelInPercent</span><span class="p">();</span>
<span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;FillLevel: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">fillLevel</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; %&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getCurrentSetpoint</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// &quot;True&quot; is &quot;fill&quot;</span>
<span class="w">            </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">fillLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// &quot;False&quot; is &quot;drain&quot;</span>
<span class="w">            </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fillLevel</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>


<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">completing</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">completed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;FillTankServiceHandler: LiquidProcedure: Completing&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setInletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setOutletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

<span class="w">        </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">holding</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">completed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">completing</span><span class="p">(</span><span class="n">completed</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completed</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Remember how EXECUTING had to wrestle away control from the POL? This is where we give it back</span>
<span class="w">            </span><span class="c1">// so that the POL can leave HELD once the error is cleared.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestModeControl</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
</section>
<section id="the-control-engine">
<h2>The Control Engine<a class="headerlink" href="#the-control-engine" title="Link to this heading"></a></h2>
<p>The control engine ties a MTP instance to an OPC UA server instance.
The control engine also houses all our service handlers as well as any “global” variables that are not required as part of a service.</p>
<p>Let’s grab what we need from the CENA and move straight into the class.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;controlengine/MtpControlEngine.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;timing/BasicTimer.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;opcua/open62541/OpcUaServerOpen62541.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/AnaView.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/PeaInformationLabel.hpp&quot;</span>

<span class="k">using</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">cena</span><span class="o">::</span><span class="n">reflection</span><span class="o">::</span><span class="n">opcua</span><span class="o">::</span><span class="n">OpcUaServerOpen62541</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ControlEngine</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpControlEngine</span>
<span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
</pre></div>
</div>
<p>The CENA manages the OPC UA Server instance, but the instance is provided by dependency injection</p>
<p>and is likely to be shared with other classes</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">OpcUaServerOpen62541</span><span class="o">&gt;</span><span class="w"> </span><span class="n">opcuaServer</span><span class="p">;</span><span class="w"> </span><span class="c1">// Co-Owned by base class and reflection</span>
</pre></div>
</div>
<p>The CE houses the processController, which it shares with the ServiceHandlers but also uses itself</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">;</span>
</pre></div>
</div>
<p>The CE houses all our service handlers</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">FillTankServiceHandler</span><span class="w"> </span><span class="n">liquidService</span><span class="p">;</span>
</pre></div>
</div>
<p>The ControlEngine class is the parent class for any global DataAssemblies, i.e. the ones that are not directly
tied to a procedure’s inner workings. This may include</p>
<ul class="simple">
<li><p>simple diagnostic outputs</p></li>
<li><p>ActiveElements, such as valves and drives, which will also have their callbacks assigned in/by the CE</p></li>
</ul>
<p>We want to be able to view the fill level of our tank. It is not critical to any service, but nice to</p>
<p>watch. So we will add it to the global scope and let <cite>ControlEngine::update()</cite> handle the logic.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">AnaView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fillLevel</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>
</pre></div>
</div>
<p>The magic of the CE is hidden in its three task function, which will in essence drive the entire CE and MTP
related logic.</p>
<p>Our base classes behavior needs to be explained a bit though:</p>
<p><strong>MtpControlEngine::start( )</strong> will create the MTP and invoke our overridden <code class="docutils literal notranslate"><span class="pre">initializeMtpContents()</span></code>
(which will, in turn, invoke the service handlers <code class="docutils literal notranslate"><span class="pre">initializeMtpContents()</span></code>). MtpControlEngine will then
proceed to <strong>reflect the MTP on OPC UA</strong>: That means that everything in the MTP at this point in time will
automatically be re-created in OPC UA. Our base class handles this. We just need to stick to our initialization
pattern.</p>
<p><strong>MtpControlEngine::iterate( )</strong> will perform any mtp related content updates for us, like invoking callbacks on
ActiveElements or ticking the state logic of our services (which would in turn invoke callbacks in our service
handlers). Our base class is a <cite>FrequencyLimitedTaskLoopTask</cite>: that means that we can invoke <code class="docutils literal notranslate"><span class="pre">iterate()</span></code> as often
as we want, but the MTP Model Core logic will only tick every X ms - so this is the frequency our MTP business
logic will be invoked with.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// This order is **very important**:</span>
<span class="w">        </span><span class="c1">// Call the server&#39;s start() first, because the control engine&#39;s start will create the mtp and reflect it!</span>
<span class="w">        </span><span class="c1">// So the server always needs to be started/initialized first!</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">opcuaServer</span><span class="o">-&gt;</span><span class="n">doStart</span><span class="p">();</span>

<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">MtpControlEngine</span><span class="o">::</span><span class="n">start</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">iterate</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// The first update triggers the CE (and any service handler) to update their DataAssemblies from/to the</span>
<span class="w">        </span><span class="c1">// process handler.</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">MtpControlEngine</span><span class="o">::</span><span class="n">iterate</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">MtpControlEngine</span><span class="o">::</span><span class="n">stop</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">opcuaServer</span><span class="o">-&gt;</span><span class="n">doTerminate</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="k">public</span><span class="o">:</span>
</pre></div>
</div>
<p>The constructor initializes the MtpControlEngine base class and accepts a server via dependency injection.</p>
<p>Obviously, we also need to initialize our Service Handlers, our <cite>fillLevel</cite> AnaView as well as any other global DataAssembly.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ControlEngine</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">OpcUaServerOpen62541</span><span class="o">&gt;</span><span class="w"> </span><span class="n">opcuaServer</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w">   </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpControlEngine</span><span class="p">(</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">locking</span><span class="o">::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">timing</span><span class="o">::</span><span class="n">BasicTimer</span><span class="o">&gt;</span><span class="p">(),</span>
<span class="w">                               </span><span class="n">opcuaServer</span><span class="p">,</span>
<span class="w">                               </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="c1">// Update only every 100ms</span>
<span class="w">                               </span><span class="s">&quot;ExamplePEA&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;BeverageProduction&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;https://semodia.com/aas/ExamplePEA/manual.pdf&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;123&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;Semodia GmbH&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;https://semodia.com&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;Product_C0DE&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;https://semodia.com/aas/ExamplePEA/666&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;666&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;3.0.0&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;Semodia GmbH&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;https://semodia.com&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="s">&quot;http://localhost:5000&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">opcuaServer</span><span class="p">(</span><span class="n">opcuaServer</span><span class="p">),</span>
<span class="w">        </span><span class="n">process</span><span class="p">(</span><span class="n">process</span><span class="p">),</span>
<span class="w">        </span><span class="n">liquidService</span><span class="p">(</span><span class="n">process</span><span class="p">),</span>
<span class="w">        </span><span class="n">fillLevel</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">AnaView</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;FillLevel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The Tanks current fill level&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">UnitCode</span><span class="o">::</span><span class="n">PERCENT</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ControlEngine</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>MTP and Process are linked statefully; this class MUST NOT be trivially copied</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">ControlEngine</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ControlEngine</span><span class="w"> </span><span class="o">&amp;</span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span>
<span class="n">ControlEngine</span><span class="w"> </span><span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ControlEngine</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">initializeMtpContents()</span></code> works quite similarly to what we encountered in the ServiceHandlers and has
many of the same tasks:</p>
<ul class="simple">
<li><dl class="simple">
<dt>For each global DataAssembly:</dt><dd><ul>
<li><p>Add it to the mtp</p></li>
<li><p>Assign a static NodeId</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Additionally, for each ActiveElement: Assign Callbacks</p></li>
<li><p>Invoke the initializer of each of our service handlers.</p></li>
</ul>
<p>initializeMtpContents is invoked by our MtpControlEngine base class to set up the MTP.</p>
<p>At this point, MtpControlEngine has already created the mtp (which has become part of our protected scope)</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeMtpContents</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Our AnaView might need some static nodeIds</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="o">-&gt;</span><span class="n">getV</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=fillLevel_V&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">addDataAssembly</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Some parts of the PeaInformationLabel have to be available at runtime</span>

<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getAssetId</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.AssetId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getComponentName</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.ComponentName&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDeviceClass</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.DeviceClass&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDeviceHealth</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.DeviceHealth&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDeviceManual</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.DeviceManual&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDeviceRevision</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.DeviceRevision&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getHardwareRevision</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.HardwareRevision&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getManufacturer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.Manufacturer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getManufacturerUri</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.ManufacturerUri&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getModel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.Model&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProductCode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.ProductCode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProductInstanceUri</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.ProductInstanceUri&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getRevisionCounter</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.RevisionCounter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSerialNumber</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.SerialNumber&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSoftwareRevision</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.SoftwareRevision&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>



<span class="w">    </span><span class="c1">// Invoke each of our service handlers</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="p">.</span><span class="n">initializeMtpContents</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="p">);</span>
<span class="w">    </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Control Engine&#39;s MTP is initialized&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As with the ServiceHandler, <cite>update()</cite> performs MTP-related updates and ticks our state machine. It also</p>
<p>invokes our <cite>ServiceHandler::update()</cite> as required.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Update our data assemblies:</span>
<span class="w">        </span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">getFillLevelInPercent</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="o">-&gt;</span><span class="n">setQualityCode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">QualityCode</span><span class="o">::</span><span class="n">OUT_OF_SPECIFICATION</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="o">-&gt;</span><span class="n">setQualityCode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">QualityCode</span><span class="o">::</span><span class="n">OK</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Update each of our services:</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="p">.</span><span class="n">update</span><span class="p">();</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="the-main-application">
<h2>The Main Application<a class="headerlink" href="#the-main-application" title="Link to this heading"></a></h2>
<p>The main application links all our components (ProcessController, ControlEngine) together. In a real-world
scenario, it is responsible for choosing the specific implementations of any dependency-injected class, handles
command-line-options and also constructs the logging-mechanism.</p>
<p>Every main application has 3 parts:</p>
<ol class="arabic simple">
<li><p>System Setup (I/O configuration, logging, creating our classes)</p></li>
<li><p>The main loop</p></li>
<li><p>Shutdown and Cleanup</p></li>
</ol>
<p>CENA is designed to be used in both multi-threaded and task-loop-type applications; we will only explore
the task loop concept here. A threaded application would however not deviate from the above pattern at all.
The main loop would simply not do much.</p>
<p>Let’s start with setting up our classes:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">([[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="p">[[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span><span class="w"> </span><span class="n">stopHandler</span><span class="p">);</span>
<span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span><span class="w"> </span><span class="n">stopHandler</span><span class="p">);</span>

<span class="w">    </span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Welcome to our ControlEngine Example&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span><span class="p">);</span><span class="w"> </span><span class="c1">// ~ 20s till full or empty</span>
<span class="w">    </span><span class="n">process</span><span class="o">-&gt;</span><span class="n">doStart</span><span class="p">();</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">uaServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">OpcUaServerOpen62541</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">locking</span><span class="o">::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">locking</span><span class="o">::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">());</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">controlEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ControlEngine</span><span class="o">&gt;</span><span class="p">(</span><span class="n">uaServer</span><span class="p">,</span><span class="w"> </span><span class="n">process</span><span class="p">);</span>
<span class="w">    </span><span class="n">controlEngine</span><span class="o">-&gt;</span><span class="n">doStart</span><span class="p">();</span>
</pre></div>
</div>
<section id="the-loop">
<h3>The loop<a class="headerlink" href="#the-loop" title="Link to this heading"></a></h3>
<p>The following loop will update our control engine, perform any process I/O in a separate (non-blocking) step
and update any MTP contents.</p>
<p>Note what happens in regard to the <cite>usleep</cite>-directive:</p>
<ul class="simple">
<li><p>The process is updated every 1ms,</p></li>
<li><p>The controlEngine is updated every 1ms, but the MTPControlEngine underneath it is a time-limited task! So
it will only invoke our business logic every 100ms, no matter how often we update it!</p></li>
<li><p>The OPC UA Server is probably the task that requires the highest rate of repetition and the sole reason
we need to sleep in the tens-of-milliseconds-regime instead of hundreds-of-milliseconds.</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running the control engine&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">uaServer</span><span class="o">-&gt;</span><span class="n">doRun</span><span class="p">();</span>
<span class="w">        </span><span class="n">controlEngine</span><span class="o">-&gt;</span><span class="n">doRun</span><span class="p">();</span>
<span class="w">        </span><span class="n">process</span><span class="o">-&gt;</span><span class="n">doRun</span><span class="p">();</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">process</span><span class="o">-&gt;</span><span class="n">doTerminate</span><span class="p">();</span>
<span class="w">    </span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Bye-Bye&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="running-the-ce">
<span id="run-the-ce"></span><h2>Running the CE<a class="headerlink" href="#running-the-ce" title="Link to this heading"></a></h2>
<p>Chances are you want to try out our CE, right? Here’s how to do that.</p>
<p>First, get an OPC UA Client and connect to <cite>opc.tcp://127.0.0.1:4840</cite>. You should see our “ExamplePEA” in the address
space.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are using UA Expert, you can use an UA template file <a class="reference external" href="https://github.com/Semodia-GmbH/github-test/blob/main/README.md">examplePEA.uap</a>. This automatically connects to the specified ip address and subscribes the relevant attributes to control our tank module.</p>
</div>
<p>Next, subscribe to these values:</p>
<p class="plantuml">
<img src="../../../_images/plantuml-0d200a90f3a6623290e826fbe9c75d9bc71efdfd.png" alt="&#64;startsalt
{{T
 + ExamplePEA
 ++ Communications
 +++ Instances
 ++++ FillLevel
 +++++ V    **(fillLevel-&gt;V)**
 ++ Control
 +++ Services
 ++++ Service_0
 +++++ ReferencedServiceControl
 ++++++ CommandOp **(liquidService-&gt;CommandOp)**
 ++++++ StateCur   **(liquidService-&gt;StateCur)**
 ++++++ PrecedureOp   **(liquidService-&gt;PrecedureOp)**
 ++++++ PrecedureReq   **(liquidService-&gt;PrecedureReq)**
 ++++++ PrecedureCur   **(liquidService-&gt;PrecedureCur)**
 ++++++ ServiceOperationMode
 +++++++ StateOpAct **(liquidService-&gt;StateOpAct)**
 +++++++ StateOpOp  **(liquidService-&gt;StateOpOp)**
 +++++ mtp::Procedures
 ++++++ mtp::Procedure_0
 +++++++ ProcedureParameters
 ++++++++ ProcedureParameter_0
 +++++++++ ReferencedDataAssembly
 ++++++++++ Apply
 +++++++++++ ApplyEn  **(fillTank-&gt;ApplyEn)**
 +++++++++++ ApplyOp  **(fillTank-&gt;ApplyOp)**
 ++++++++++ VOp  **(fillTank-&gt;VOp)**
 ++++++++++ VOut **(fillTank-&gt;VOut)**
 ++++++++++ VReq **(fillTank-&gt;VOut)**
 +++++++ ProcessValueOuts
 ++++++++ ProcessValueOut_0
 +++++++++ ReferencedDataAssembly
 ++++++++++ V    **(inletValveState-&gt;V)**
 ++++++++ ProcessValueOut_1
 +++++++++ ReferencedDataAssembly
 ++++++++++ V    **(outletValveState-&gt;V)**
}}
&#64;endsalt"/>
</p>
<p>The tank fill level should be 0%.</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>Set <cite>liquidService-&gt;StateOpOp</cite> to true</dt><dd><ul class="simple">
<li><p><cite>liquidService-&gt;StateOpAct</cite> should become true</p></li>
<li><p><cite>liquidService-&gt;StateCur</cite> should become 16 (IDLE)</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>By default the PEA is controlled internally, this command tells the PEA that the liquidService shall be controlled by us (the operator).</p>
<ol class="arabic simple" start="2">
<li><dl class="simple">
<dt>Set <cite>liquidService-&gt;ProcedureOp</cite> to “1”</dt><dd><ul class="simple">
<li><p><cite>fillTank-&gt;ProcedureReq</cite> will become 1</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>This requests the procedure that should be executed. In our case we only have one that fills and drains the tank.</p>
<ol class="arabic simple" start="3">
<li><dl class="simple">
<dt>Set <cite>fillTank-&gt;VOp</cite> to true</dt><dd><ul class="simple">
<li><p><cite>fillTank-&gt;VReq</cite> will be <cite>true</cite></p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>This is a parameter of our fill tank procedure. True indicates that we want to fill the tank instead of draining.</p>
<ol class="arabic simple" start="4">
<li><dl class="simple">
<dt>Set <cite>fillTank-&gt;ApplyOp</cite> to <cite>true</cite></dt><dd><ul class="simple">
<li><p><cite>fillTank-&gt;VOut</cite> will be become <cite>true</cite> as requested; the info-callback should be printed on the command line</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>This now applies the procedure parameter and it is ready to use for our procedure.</p>
<ol class="arabic simple" start="5">
<li><dl class="simple">
<dt>Set <cite>liquidService-&gt;CommandOp</cite> to “4” (START)</dt><dd><ul class="simple">
<li><p><cite>fillTank-&gt;ApplyEn</cite> should become <cite>false</cite></p></li>
<li><p><cite>fillTank-&gt;VOut</cite> should become <cite>true</cite></p></li>
<li><p><cite>liquidService-&gt;StateCur</cite> should become 64 (EXECUTING)</p></li>
<li><p>The tank level should rise to 100% in ~20 seconds</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>This operation basically sends the command “START” to the PEA, which then executes the previously requested procedure with the set procedure parameters. In our case to fill the tank.</p>
<ol class="arabic simple" start="6">
<li><dl class="simple">
<dt>The tank level will start to rise</dt><dd><ul class="simple">
<li><p>when 100% are reached, <cite>liquidService-&gt;StateCur</cite> should become 131072 (COMPLETED)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Set <cite>liquidService-&gt;CommandOp</cite> to “2” (RESET)</dt><dd><ul class="simple">
<li><p><cite>liquidService-&gt;StateCur</cite> should become 16 (IDLE) (its going through RESETTING, but its probably so fast you won’t see that)</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>After a procedure is completed it needs to be reset to go back in the IDLE state.</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>Set <cite>fillTank-&gt;VOp</cite> to false</dt><dd><ul class="simple">
<li><p><cite>fillTank-&gt;VReq</cite> will be <cite>false</cite></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Set <cite>fillTank-&gt;ApplyOp</cite> to <cite>true</cite></dt><dd><ul class="simple">
<li><p><cite>fillTank-&gt;VOut</cite> will be become <cite>false</cite> as requested</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Set <cite>liquidService-&gt;CommandOp</cite> to “4” (START)</dt><dd><ul class="simple">
<li><p>The tank level should decrease</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>Hit <cite>Ctrl+C</cite> to stop the example once you get bored.</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>In just over 500 lines of code, we created an entire MTP Control Engine. Our example is even likely to work in the
real world with marginally more effort if we could open/close real valves with digital I/Os.</p>
<p>The complexity of a CE is largely hidden in the methodical and quite repetitious application of creating the
<cite>ServiceHandler</cite> and <cite>ControlEngine</cite>. Also, the requirement to assign NodeIds in accordance with the MTP file
tends to become tedious, but is easily automated.</p>
</section>
<section id="source-code">
<h2>Source Code<a class="headerlink" href="#source-code" title="Link to this heading"></a></h2>
<p>Here’s the complete source code from this example:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="linenos">  3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="linenos">  4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span>
<span class="linenos">  5</span>
<span class="linenos">  6</span><span class="kt">void</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">  7</span><span class="p">{</span>
<span class="linenos">  8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="linenos">  9</span><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="linenos"> 10</span><span class="p">}</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">debug</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;DEBUG&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 13</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;INFO &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 14</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;ERROR&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span>
<span class="linenos"> 17</span><span class="p">{</span>
<span class="linenos"> 18</span><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="linenos"> 19</span><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;signal.h&gt;</span>
<span class="linenos"> 20</span><span class="p">}</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 23</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stopHandler</span><span class="p">([[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sign</span><span class="p">)</span>
<span class="linenos"> 24</span><span class="p">{</span>
<span class="linenos"> 25</span><span class="w">    </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 26</span><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="linenos"> 27</span><span class="p">}</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="k">class</span><span class="w"> </span><span class="nc">IProcessController</span>
<span class="linenos"> 30</span><span class="p">{</span>
<span class="linenos"> 31</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 32</span><span class="w">    </span><span class="n">IProcessController</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="linenos"> 33</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">IProcessController</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isFaultPresent</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setInletValveOpen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setOutletValveOpen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 40</span>
<span class="linenos"> 41</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isInletValveOpen</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isOutletValveOpen</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getFillLevelInPercent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 46</span><span class="p">};</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
<span class="linenos"> 51</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;tasking/BasicTaskLoopTask.hpp&quot;</span>
<span class="linenos"> 52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;locking/Lock.hpp&quot;</span>
<span class="linenos"> 53</span><span class="k">namespace</span><span class="w"> </span><span class="nn">cena</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">semodia</span><span class="o">::</span><span class="nn">controlengine</span><span class="o">::</span><span class="nn">native</span><span class="p">;</span>
<span class="linenos"> 54</span><span class="k">using</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">tasking</span><span class="o">::</span><span class="n">BasicTaskLoopTask</span><span class="p">;</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="k">class</span><span class="w"> </span><span class="nc">ProcessController</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IProcessController</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BasicTaskLoopTask</span>
<span class="linenos"> 57</span><span class="p">{</span>
<span class="linenos"> 58</span><span class="k">private</span><span class="o">:</span>
<span class="linenos"> 59</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tankCapacity</span><span class="p">;</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">tankContents</span><span class="p">;</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">flowRate</span><span class="p">;</span><span class="w"> </span><span class="c1">// in liquid units/second</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">inletValveOpen</span><span class="p">;</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">outletValveOpen</span><span class="p">;</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="w"> </span><span class="n">lastUpdate</span><span class="p">;</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">getMicroSecondsElapsedSinceLastUpdate</span><span class="p">()</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 72</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">().</span><span class="n">time_since_epoch</span><span class="p">())</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastUpdate</span><span class="p">).</span><span class="n">count</span><span class="p">());</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">markLastUpdateNow</span><span class="p">()</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 77</span><span class="w">        </span><span class="n">lastUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">().</span><span class="n">time_since_epoch</span><span class="p">());</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 79</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">iterate</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 83</span><span class="w">        </span><span class="c1">// Get the time perioid that passed since the last iteration</span>
<span class="linenos"> 84</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getMicroSecondsElapsedSinceLastUpdate</span><span class="p">();</span>
<span class="linenos"> 85</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000000.f</span><span class="p">;</span>
<span class="linenos"> 86</span><span class="w">        </span><span class="c1">// Fill and/or drain. Yes. We can do both. We are THAT GOOD!</span>
<span class="linenos"> 87</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">inletValveOpen</span><span class="p">)</span>
<span class="linenos"> 88</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 89</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">flowRate</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seconds</span><span class="p">;</span>
<span class="linenos"> 90</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 91</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">outletValveOpen</span><span class="p">)</span>
<span class="linenos"> 92</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 93</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">flowRate</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seconds</span><span class="p">;</span>
<span class="linenos"> 94</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">        </span><span class="c1">// Prevent overfilling and underdraining:</span>
<span class="linenos"> 97</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankCapacity</span><span class="p">)</span>
<span class="linenos"> 98</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 99</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankCapacity</span><span class="p">;</span>
<span class="linenos">100</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">101</span><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">102</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">103</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">104</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="w">        </span><span class="c1">// Update the timestamp</span>
<span class="linenos">107</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">markLastUpdateNow</span><span class="p">();</span>
<span class="linenos">108</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">109</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">112</span><span class="w">    </span><span class="n">ProcessController</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">tankCapacity</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">flowRate</span><span class="p">)</span>
<span class="linenos">113</span><span class="w">        </span><span class="o">:</span><span class="w">   </span><span class="n">IProcessController</span><span class="p">(),</span>
<span class="linenos">114</span><span class="w">            </span><span class="n">BasicTaskLoopTask</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">locking</span><span class="o">::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">()),</span>
<span class="linenos">115</span><span class="w">            </span><span class="n">tankCapacity</span><span class="p">(</span><span class="n">tankCapacity</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tankCapacity</span><span class="p">),</span>
<span class="linenos">116</span><span class="w">            </span><span class="n">tankContents</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="linenos">117</span><span class="w">            </span><span class="n">flowRate</span><span class="p">(</span><span class="n">flowRate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">flowRate</span><span class="p">),</span>
<span class="linenos">118</span><span class="w">            </span><span class="n">inletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
<span class="linenos">119</span><span class="w">            </span><span class="n">outletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="linenos">120</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">121</span><span class="w">        </span><span class="n">markLastUpdateNow</span><span class="p">();</span>
<span class="linenos">122</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">123</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ProcessController</span><span class="p">()</span>
<span class="linenos">126</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">127</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">128</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="w">    </span><span class="n">ProcessController</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ProcessController</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span>
<span class="linenos">131</span><span class="w">    </span><span class="n">ProcessController</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ProcessController</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span>
<span class="linenos">132</span>
<span class="linenos">133</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isFaultPresent</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">134</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">135</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">136</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setInletValveOpen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">&amp;</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">139</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">140</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">;</span>
<span class="linenos">141</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">142</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">143</span>
<span class="linenos">144</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setOutletValveOpen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">&amp;</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">145</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">146</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">;</span>
<span class="linenos">147</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">148</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">149</span>
<span class="linenos">150</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isInletValveOpen</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">151</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">152</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveOpen</span><span class="p">;</span>
<span class="linenos">153</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isOutletValveOpen</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">156</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">157</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveOpen</span><span class="p">;</span>
<span class="linenos">158</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">159</span>
<span class="linenos">160</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getFillLevelInPercent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">161</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">162</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">100.f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankContents</span><span class="o">/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tankCapacity</span><span class="p">);</span>
<span class="linenos">163</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">164</span><span class="p">};</span>
<span class="linenos">165</span>
<span class="linenos">166</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ModuleTypePackage.hpp&quot;</span>
<span class="linenos">167</span><span class="k">namespace</span><span class="w"> </span><span class="nn">mtp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">cena</span><span class="o">::</span><span class="nn">model</span><span class="o">::</span><span class="nn">mtp</span><span class="p">;</span>
<span class="linenos">168</span>
<span class="linenos">169</span><span class="k">class</span><span class="w"> </span><span class="nc">IServiceHandler</span>
<span class="linenos">170</span><span class="p">{</span>
<span class="linenos">171</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">172</span><span class="w">    </span><span class="n">IServiceHandler</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="linenos">173</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">IServiceHandler</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="linenos">174</span>
<span class="linenos">175</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">176</span>
<span class="linenos">177</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeMtpContents</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ModuleTypePackage</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mtp</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">178</span><span class="p">};</span>
<span class="linenos">179</span>
<span class="linenos">180</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
<span class="linenos">181</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/BinView.hpp&quot;</span>
<span class="linenos">182</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/BinServParam.hpp&quot;</span>
<span class="linenos">183</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/Service.hpp&quot;</span>
<span class="linenos">184</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ServiceSet.hpp&quot;</span>
<span class="linenos">185</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ServiceControl.hpp&quot;</span>
<span class="linenos">186</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/Procedure.hpp&quot;</span>
<span class="linenos">187</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ServiceSourceModeBaseFunction.hpp&quot;</span>
<span class="linenos">188</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/ServiceOperationModeBaseFunction.hpp&quot;</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="k">namespace</span><span class="w"> </span><span class="nn">mtp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">semodia</span><span class="o">::</span><span class="nn">controlengine</span><span class="o">::</span><span class="nn">native</span><span class="o">::</span><span class="nn">model</span><span class="o">::</span><span class="nn">mtp</span><span class="p">;</span>
<span class="linenos">191</span>
<span class="linenos">192</span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">(</span><span class="s">&quot;https://yourNamespace.com&quot;</span><span class="p">);</span>
<span class="linenos">193</span>
<span class="linenos">194</span><span class="k">class</span><span class="w"> </span><span class="nc">FillTankServiceHandler</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IServiceHandler</span>
<span class="linenos">195</span><span class="p">{</span>
<span class="linenos">196</span><span class="k">private</span><span class="o">:</span>
<span class="linenos">197</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">Service</span><span class="o">&gt;</span><span class="w"> </span><span class="n">liquidService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="linenos">198</span>
<span class="linenos">199</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">200</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinServParam</span><span class="o">&gt;</span><span class="w"> </span><span class="n">procedureModeFillTank</span><span class="p">;</span>
<span class="linenos">201</span>
<span class="linenos">202</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inletValveState</span><span class="p">;</span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outletValveState</span><span class="p">;</span>
<span class="linenos">205</span>
<span class="linenos">206</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">;</span>
<span class="linenos">207</span>
<span class="linenos">208</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">209</span><span class="w">    </span><span class="n">FillTankServiceHandler</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">)</span>
<span class="linenos">210</span><span class="w">        </span><span class="o">:</span><span class="w">   </span><span class="n">procedureModeFillTank</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinServParam</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;fillTank&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Instruction to fill or drain the tank&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;True means fill&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;False means drain&quot;</span><span class="p">)),</span>
<span class="linenos">211</span><span class="w">            </span><span class="n">inletValveState</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinView</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;inletValveState&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Valve controlling liquid going into the tank&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;True means open&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;False means closed&quot;</span><span class="p">)),</span>
<span class="linenos">212</span><span class="w">            </span><span class="n">outletValveState</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">BinView</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;outletValveState&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Valve controlling liquid going into the tank&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;True means open&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;False means closed&quot;</span><span class="p">)),</span>
<span class="linenos">213</span><span class="w">            </span><span class="n">process</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
<span class="linenos">214</span>
<span class="linenos">215</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">216</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">217</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">218</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">FillTankServiceHandler</span><span class="p">()</span>
<span class="linenos">219</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">220</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">221</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">222</span>
<span class="linenos">223</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">initializeMtpContents</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ModuleTypePackage</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mtp</span><span class="p">)</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">224</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">225</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="o">-&gt;</span><span class="n">getV</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=InletValveState_V&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">226</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="o">-&gt;</span><span class="n">getWQC</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=InletValveState_WQC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">227</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="o">-&gt;</span><span class="n">getV</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=OutletValveState_V&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">228</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="o">-&gt;</span><span class="n">getWQC</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=OutletValveState_WQC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">229</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">230</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">231</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">232</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVOut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VOut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">233</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getVReq</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_VReq&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">234</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyEn</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_ApplyEn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">235</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_ApplyOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">236</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_ApplyExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">237</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=ProcedureModeFillTank_ApplyIn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">238</span>
<span class="linenos">239</span><span class="w">        </span><span class="n">mtp</span><span class="p">.</span><span class="n">getControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">createService</span><span class="p">(</span><span class="s">&quot;FillTankService&quot;</span><span class="p">);</span>
<span class="linenos">240</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mtp</span><span class="p">.</span><span class="n">getControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceByName</span><span class="p">(</span><span class="s">&quot;FillTankService&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">liquidService</span><span class="p">))</span>
<span class="linenos">241</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">242</span><span class="w">            </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Created FillTankService&quot;</span><span class="p">);</span>
<span class="linenos">243</span>
<span class="linenos">244</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">procedureIdAssignedByService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">245</span><span class="w">            </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">createProcedure</span><span class="p">(</span><span class="s">&quot;FillTank&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w">  </span><span class="n">procedureIdAssignedByService</span><span class="p">,</span>
<span class="linenos">246</span><span class="w">                 </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">mtp</span><span class="o">::</span><span class="n">ProcedureHealthView</span><span class="o">&amp;</span><span class="w"> </span><span class="n">commandInfo</span><span class="p">)</span>
<span class="linenos">247</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">248</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">COMPLETE</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">249</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">ABORT</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">250</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">HOLD</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">251</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">STOP</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">252</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">RESET</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">253</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isFaultPresent</span><span class="p">()));</span>
<span class="linenos">254</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">HOLD</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isFaultPresent</span><span class="p">());</span>
<span class="linenos">255</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">UNHOLD</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isFaultPresent</span><span class="p">()));</span>
<span class="linenos">256</span>
<span class="linenos">257</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">RESTART</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">258</span><span class="w">                    </span><span class="n">commandInfo</span><span class="p">.</span><span class="n">setCommandEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">PAUSE</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">259</span><span class="w">                    </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">260</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">261</span><span class="w">            </span><span class="p">);</span>
<span class="linenos">262</span>
<span class="linenos">263</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">procedureIdAssignedByService</span><span class="p">)</span>
<span class="linenos">264</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">265</span><span class="w">                </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;We expected ProcedureId 1... but the CENA has assigned another ID&quot;</span><span class="p">);</span>
<span class="linenos">266</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">267</span>
<span class="linenos">268</span><span class="w">            </span><span class="c1">// Procedure fillTank (intended to be selectable using MTP procedure ID 1 and to be self-completing)</span>
<span class="linenos">269</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">Procedure</span><span class="o">&gt;</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"> </span><span class="c1">// We&#39;ll need this</span>
<span class="linenos">270</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getProcedureByName</span><span class="p">(</span><span class="s">&quot;FillTank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="p">))</span>
<span class="linenos">271</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">272</span><span class="w">                </span><span class="c1">// Add the `ProcedureParameters` (which work exactly like `ConfigurationParameters`)</span>
<span class="linenos">273</span><span class="w">                </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">createProcedureParameter</span><span class="p">(</span><span class="s">&quot;FillMode&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="p">);</span>
<span class="linenos">274</span>
<span class="linenos">275</span><span class="w">                </span><span class="c1">// add ReportValues</span>
<span class="linenos">276</span><span class="w">                </span><span class="c1">// ... if we had any, which we don&#39;t</span>
<span class="linenos">277</span>
<span class="linenos">278</span><span class="w">                </span><span class="c1">// ProcessValueOut</span>
<span class="linenos">279</span><span class="w">                </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">createProcessValueOut</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="p">);</span>
<span class="linenos">280</span><span class="w">                </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">createProcessValueOut</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="p">);</span>
<span class="linenos">281</span>
<span class="linenos">282</span><span class="w">                </span><span class="c1">// add ProcessValueIns</span>
<span class="linenos">283</span><span class="w">                </span><span class="c1">// ... if we had any, which we don&#39;t</span>
<span class="linenos">284</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">285</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">286</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">287</span><span class="w">                </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;MTP Initialization: Creating procedure &#39;FillTank&#39; failed&quot;</span><span class="p">);</span>
<span class="linenos">288</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">289</span>
<span class="linenos">290</span><span class="w">            </span><span class="c1">// &lt;&lt; If we had more procedures, they would go here</span>
<span class="linenos">291</span>
<span class="linenos">292</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateChannel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateChannel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">293</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateAutAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateAutAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">294</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOpAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOpAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">295</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOffAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOffAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">296</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOpOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOpOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">297</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateAutOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateAutOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">298</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOffOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOffOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">299</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOpAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOpAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">300</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateAutAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateAutAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">301</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceOperationMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateOffAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateOffAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">302</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandEn</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_CommandEn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">303</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_CommandOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">304</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_CommandInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">305</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_CommandExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">306</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureCur</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureCur&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">307</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">308</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">309</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">310</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStateCur</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_StateCur&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">311</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcedureReq</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcedureReq&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">312</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcParamApplyOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">313</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyEn</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcParamApplyEn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">314</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcParamApplyInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">315</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProcParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ProcParamApplyExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">316</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getConfigParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ConfigParamApplyOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">317</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getConfigParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyEn</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ConfigParamApplyEn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">318</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getConfigParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyInt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ConfigParamApplyInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">319</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getConfigParamApply</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getApplyExt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ConfigParamApplyExt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">320</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getWQC</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_WQC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">321</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOSLevel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_OSLevel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">322</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPosTextID</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_PosTextID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">323</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getInteractQuestionID</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_InteractQuestionID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">324</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getInteractAnswerID</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_InteractAnswerID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">325</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getInteractAddInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_InteractAddInfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">326</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getReportValueFreeze</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_ReportValueFreeze&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">327</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcChannel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcChannel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">328</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcExtAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcExtAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">329</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcIntAut</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcIntAut&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">330</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcIntOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcIntOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">331</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcExtOp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcExtOp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">332</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcIntAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcIntAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">333</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getReferencedServiceControl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getServiceSourceMode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSrcExtAct</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankServiceControl_SrcExtAct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">334</span>
<span class="linenos">335</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">getReferencedProcedureHealthView</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getWQC</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankHV_WQC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">336</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">getReferencedProcedureHealthView</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getCommandInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=FillTankHV_CommandInfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">337</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">338</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">339</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">340</span><span class="w">            </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to create FillTankService&quot;</span><span class="p">);</span>
<span class="linenos">341</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">342</span>
<span class="linenos">343</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">Procedure</span><span class="o">&gt;</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"> </span><span class="c1">// We&#39;ll need this</span>
<span class="linenos">344</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">getProcedureByName</span><span class="p">(</span><span class="s">&quot;FillTank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="p">))</span>
<span class="linenos">345</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">346</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">STARTING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">starting</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">347</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">RESUMING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">starting</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">348</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">UNHOLDING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">starting</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">349</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">EXECUTE</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">executing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">350</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">COMPLETING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">completing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">351</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">PAUSING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">completing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">352</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">HOLDING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">holding</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">353</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">STOPPING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">completing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">354</span><span class="w">            </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">attachUserCallback</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">ABORTING</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FillTankServiceHandler</span><span class="o">::</span><span class="n">completing</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">355</span>
<span class="linenos">356</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">allowValueUpdates</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">357</span>
<span class="linenos">358</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">ProcedureParameter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">procedureParameter</span><span class="p">;</span>
<span class="linenos">359</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpStatusCode</span><span class="o">::</span><span class="n">GOOD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">liquidProcedure</span><span class="o">-&gt;</span><span class="n">getProcedureParameterByName</span><span class="p">(</span><span class="s">&quot;FillMode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">procedureParameter</span><span class="p">))</span>
<span class="linenos">360</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">361</span><span class="w">                </span><span class="n">procedureParameter</span><span class="o">-&gt;</span><span class="n">setStateBasedUpdateEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">IDLE</span><span class="p">,</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">StateBasedUpdateEnableSetting</span><span class="o">::</span><span class="n">EnabledByState</span><span class="p">);</span>
<span class="linenos">362</span><span class="w">                </span><span class="n">procedureParameter</span><span class="o">-&gt;</span><span class="n">setStateBasedUpdateEnable</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceStateId</span><span class="o">::</span><span class="n">STARTING</span><span class="p">,</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">StateBasedUpdateEnableSetting</span><span class="o">::</span><span class="n">DisabledByState</span><span class="p">);</span>
<span class="linenos">363</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">364</span>
<span class="linenos">365</span><span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">procedureModeFillTankReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="p">;</span>
<span class="linenos">366</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">afterApplyDo</span><span class="p">([</span><span class="n">procedureModeFillTankReference</span><span class="p">](){</span>
<span class="linenos">367</span><span class="w">                </span><span class="n">info</span><span class="p">(</span><span class="s">&quot;The mode of filling the tank was changed to `&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">procedureModeFillTankReference</span><span class="o">-&gt;</span><span class="n">getCurrentSetpoint</span><span class="p">()))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;`&quot;</span><span class="p">);</span>
<span class="linenos">368</span><span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">369</span><span class="w">            </span><span class="p">});</span>
<span class="linenos">370</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">371</span>
<span class="linenos">372</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">liquidService</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="linenos">373</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">374</span><span class="w">            </span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestModeControl</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">375</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">376</span>
<span class="linenos">377</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">requestModeControl</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">378</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">setSync</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">379</span>
<span class="linenos">380</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">381</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">382</span>
<span class="linenos">383</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">update</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">384</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">385</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">386</span><span class="w">            </span><span class="c1">// Note how [Bin/DInt/Ana/String]View-Types can update their VOut by assigning the appropriate type.</span>
<span class="linenos">387</span><span class="w">            </span><span class="c1">// For ParameterElements, this would affect VFbk.</span>
<span class="linenos">388</span><span class="w">            </span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isInletValveOpen</span><span class="p">();</span>
<span class="linenos">389</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inletValveState</span><span class="o">-&gt;</span><span class="n">setQualityCode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">QualityCode</span><span class="o">::</span><span class="n">OK</span><span class="p">);</span>
<span class="linenos">390</span>
<span class="linenos">391</span><span class="w">            </span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isOutletValveOpen</span><span class="p">();</span>
<span class="linenos">392</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">outletValveState</span><span class="o">-&gt;</span><span class="n">setQualityCode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">QualityCode</span><span class="o">::</span><span class="n">OK</span><span class="p">);</span>
<span class="linenos">393</span>
<span class="linenos">394</span><span class="w">            </span><span class="c1">// &lt;&lt; We don&#39;t have any ProcessValueIns to write to the process, but if we had some, they would go here</span>
<span class="linenos">395</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">396</span>
<span class="linenos">397</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">398</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">399</span>
<span class="linenos">400</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">starting</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">completed</span><span class="p">)</span>
<span class="linenos">401</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">402</span><span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;FillTankServiceHandler: LiquidProcedure: Starting&quot;</span><span class="p">);</span>
<span class="linenos">403</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getCurrentSetpoint</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="linenos">404</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">405</span><span class="w">            </span><span class="c1">// &quot;True&quot; is &quot;fill&quot;</span>
<span class="linenos">406</span><span class="w">            </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Commencing fill&quot;</span><span class="p">);</span>
<span class="linenos">407</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setInletValveOpen</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">408</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setOutletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">409</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">410</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">411</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">412</span><span class="w">            </span><span class="c1">// &quot;False&quot; is &quot;drain&quot;</span>
<span class="linenos">413</span><span class="w">            </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Commencing drain&quot;</span><span class="p">);</span>
<span class="linenos">414</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setInletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">415</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setOutletValveOpen</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">416</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">417</span>
<span class="linenos">418</span><span class="w">        </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">419</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">420</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">421</span>
<span class="linenos">422</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">executing</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">completed</span><span class="p">)</span>
<span class="linenos">423</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">424</span><span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;FillTankServiceHandler: LiquidProcedure: Executing&quot;</span><span class="p">);</span>
<span class="linenos">425</span><span class="w">        </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">426</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">isFaultPresent</span><span class="p">())</span>
<span class="linenos">427</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">428</span><span class="w">            </span><span class="c1">// Declare PEA as service controller and take the service to Automatic/Internal, then issue HOLD</span>
<span class="linenos">429</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="linenos">430</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">431</span><span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestModeControl</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">432</span><span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestOperationMode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">OperationModeId</span><span class="o">::</span><span class="n">Automatic</span><span class="p">,</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceSourceModeId</span><span class="o">::</span><span class="n">Internal</span><span class="p">);</span>
<span class="linenos">433</span><span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestCommand</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">ServiceCommandId</span><span class="o">::</span><span class="n">HOLD</span><span class="p">);</span>
<span class="linenos">434</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">435</span><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">436</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">437</span>
<span class="linenos">438</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">fillLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">getFillLevelInPercent</span><span class="p">();</span>
<span class="linenos">439</span><span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;FillLevel: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">fillLevel</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; %&quot;</span><span class="p">);</span>
<span class="linenos">440</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">procedureModeFillTank</span><span class="o">-&gt;</span><span class="n">getCurrentSetpoint</span><span class="p">())</span>
<span class="linenos">441</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">442</span><span class="w">            </span><span class="c1">// &quot;True&quot; is &quot;fill&quot;</span>
<span class="linenos">443</span><span class="w">            </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">fillLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="linenos">444</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">445</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">446</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">447</span><span class="w">            </span><span class="c1">// &quot;False&quot; is &quot;drain&quot;</span>
<span class="linenos">448</span><span class="w">            </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fillLevel</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">449</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">450</span>
<span class="linenos">451</span>
<span class="linenos">452</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">453</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">454</span>
<span class="linenos">455</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">completing</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">completed</span><span class="p">)</span>
<span class="linenos">456</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">457</span><span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;FillTankServiceHandler: LiquidProcedure: Completing&quot;</span><span class="p">);</span>
<span class="linenos">458</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setInletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">459</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">setOutletValveOpen</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">460</span>
<span class="linenos">461</span><span class="w">        </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">462</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">463</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">464</span>
<span class="linenos">465</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">holding</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">completed</span><span class="p">)</span>
<span class="linenos">466</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">467</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">completing</span><span class="p">(</span><span class="n">completed</span><span class="p">);</span>
<span class="linenos">468</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completed</span><span class="p">)</span>
<span class="linenos">469</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">470</span><span class="w">            </span><span class="c1">// Remember how EXECUTING had to wrestle away control from the POL? This is where we give it back</span>
<span class="linenos">471</span><span class="w">            </span><span class="c1">// so that the POL can leave HELD once the error is cleared.</span>
<span class="linenos">472</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="linenos">473</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">474</span><span class="w">                </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="o">-&gt;</span><span class="n">requestModeControl</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">475</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">476</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">477</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">478</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">479</span><span class="p">};</span>
<span class="linenos">480</span>
<span class="linenos">481</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;controlengine/MtpControlEngine.hpp&quot;</span>
<span class="linenos">482</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;timing/BasicTimer.hpp&quot;</span>
<span class="linenos">483</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;opcua/open62541/OpcUaServerOpen62541.hpp&quot;</span>
<span class="linenos">484</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/AnaView.hpp&quot;</span>
<span class="linenos">485</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mtp/PeaInformationLabel.hpp&quot;</span>
<span class="linenos">486</span>
<span class="linenos">487</span><span class="k">using</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">cena</span><span class="o">::</span><span class="n">reflection</span><span class="o">::</span><span class="n">opcua</span><span class="o">::</span><span class="n">OpcUaServerOpen62541</span><span class="p">;</span>
<span class="linenos">488</span>
<span class="linenos">489</span><span class="k">class</span><span class="w"> </span><span class="nc">ControlEngine</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpControlEngine</span>
<span class="linenos">490</span><span class="p">{</span>
<span class="linenos">491</span><span class="k">private</span><span class="o">:</span>
<span class="linenos">492</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">OpcUaServerOpen62541</span><span class="o">&gt;</span><span class="w"> </span><span class="n">opcuaServer</span><span class="p">;</span><span class="w"> </span><span class="c1">// Co-Owned by base class and reflection</span>
<span class="linenos">493</span>
<span class="linenos">494</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">;</span>
<span class="linenos">495</span>
<span class="linenos">496</span><span class="w">    </span><span class="n">FillTankServiceHandler</span><span class="w"> </span><span class="n">liquidService</span><span class="p">;</span>
<span class="linenos">497</span>
<span class="linenos">498</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">AnaView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fillLevel</span><span class="p">;</span>
<span class="linenos">499</span>
<span class="linenos">500</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">501</span>
<span class="linenos">502</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">start</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">503</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">504</span><span class="w">        </span><span class="c1">// This order is **very important**:</span>
<span class="linenos">505</span><span class="w">        </span><span class="c1">// Call the server&#39;s start() first, because the control engine&#39;s start will create the mtp and reflect it!</span>
<span class="linenos">506</span><span class="w">        </span><span class="c1">// So the server always needs to be started/initialized first!</span>
<span class="linenos">507</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">opcuaServer</span><span class="o">-&gt;</span><span class="n">doStart</span><span class="p">();</span>
<span class="linenos">508</span>
<span class="linenos">509</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">MtpControlEngine</span><span class="o">::</span><span class="n">start</span><span class="p">();</span>
<span class="linenos">510</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">511</span>
<span class="linenos">512</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">iterate</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">513</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">514</span><span class="w">        </span><span class="c1">// The first update triggers the CE (and any service handler) to update their DataAssemblies from/to the</span>
<span class="linenos">515</span><span class="w">        </span><span class="c1">// process handler.</span>
<span class="linenos">516</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">();</span>
<span class="linenos">517</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">MtpControlEngine</span><span class="o">::</span><span class="n">iterate</span><span class="p">();</span>
<span class="linenos">518</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">519</span>
<span class="linenos">520</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">stop</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">521</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">522</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">MtpControlEngine</span><span class="o">::</span><span class="n">stop</span><span class="p">();</span>
<span class="linenos">523</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">opcuaServer</span><span class="o">-&gt;</span><span class="n">doTerminate</span><span class="p">();</span>
<span class="linenos">524</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">525</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">526</span><span class="w">    </span><span class="n">ControlEngine</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">OpcUaServerOpen62541</span><span class="o">&gt;</span><span class="w"> </span><span class="n">opcuaServer</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">)</span>
<span class="linenos">527</span><span class="w">        </span><span class="o">:</span><span class="w">   </span><span class="n">mtp</span><span class="o">::</span><span class="n">MtpControlEngine</span><span class="p">(</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">locking</span><span class="o">::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">timing</span><span class="o">::</span><span class="n">BasicTimer</span><span class="o">&gt;</span><span class="p">(),</span>
<span class="linenos">528</span><span class="w">                                   </span><span class="n">opcuaServer</span><span class="p">,</span>
<span class="linenos">529</span><span class="w">                                   </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="c1">// Update only every 100ms</span>
<span class="linenos">530</span><span class="w">                                   </span><span class="s">&quot;ExamplePEA&quot;</span><span class="p">,</span>
<span class="linenos">531</span><span class="w">                                   </span><span class="s">&quot;BeverageProduction&quot;</span><span class="p">,</span>
<span class="linenos">532</span><span class="w">                                   </span><span class="s">&quot;https://semodia.com/aas/ExamplePEA/manual.pdf&quot;</span><span class="p">,</span>
<span class="linenos">533</span><span class="w">                                   </span><span class="s">&quot;123&quot;</span><span class="p">,</span>
<span class="linenos">534</span><span class="w">                                   </span><span class="s">&quot;Semodia GmbH&quot;</span><span class="p">,</span>
<span class="linenos">535</span><span class="w">                                   </span><span class="s">&quot;https://semodia.com&quot;</span><span class="p">,</span>
<span class="linenos">536</span><span class="w">                                   </span><span class="s">&quot;Product_C0DE&quot;</span><span class="p">,</span>
<span class="linenos">537</span><span class="w">                                   </span><span class="s">&quot;https://semodia.com/aas/ExamplePEA/666&quot;</span><span class="p">,</span>
<span class="linenos">538</span><span class="w">                                   </span><span class="s">&quot;666&quot;</span><span class="p">,</span>
<span class="linenos">539</span><span class="w">                                   </span><span class="s">&quot;3.0.0&quot;</span><span class="p">,</span>
<span class="linenos">540</span><span class="w">                                   </span><span class="s">&quot;Semodia GmbH&quot;</span><span class="p">,</span>
<span class="linenos">541</span><span class="w">                                   </span><span class="s">&quot;https://semodia.com&quot;</span><span class="p">,</span>
<span class="linenos">542</span><span class="w">                                   </span><span class="s">&quot;http://localhost:5000&quot;</span><span class="p">),</span>
<span class="linenos">543</span><span class="w">            </span><span class="n">opcuaServer</span><span class="p">(</span><span class="n">opcuaServer</span><span class="p">),</span>
<span class="linenos">544</span><span class="w">            </span><span class="n">process</span><span class="p">(</span><span class="n">process</span><span class="p">),</span>
<span class="linenos">545</span><span class="w">            </span><span class="n">liquidService</span><span class="p">(</span><span class="n">process</span><span class="p">),</span>
<span class="linenos">546</span><span class="w">            </span><span class="n">fillLevel</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mtp</span><span class="o">::</span><span class="n">AnaView</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;FillLevel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The Tanks current fill level&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">mtp</span><span class="o">::</span><span class="n">UnitCode</span><span class="o">::</span><span class="n">PERCENT</span><span class="p">))</span>
<span class="linenos">547</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">548</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">549</span><span class="w">    </span><span class="p">};</span>
<span class="linenos">550</span>
<span class="linenos">551</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ControlEngine</span><span class="p">()</span>
<span class="linenos">552</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">553</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">554</span><span class="w">    </span><span class="p">};</span>
<span class="linenos">555</span>
<span class="linenos">556</span><span class="w">    </span><span class="n">ControlEngine</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ControlEngine</span><span class="w"> </span><span class="o">&amp;</span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span>
<span class="linenos">557</span><span class="w">    </span><span class="n">ControlEngine</span><span class="w"> </span><span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ControlEngine</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span>
<span class="linenos">558</span>
<span class="linenos">559</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeMtpContents</span><span class="p">()</span><span class="w"> </span><span class="k">override</span>
<span class="linenos">560</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">561</span><span class="w">        </span><span class="c1">// Our AnaView might need some static nodeIds</span>
<span class="linenos">562</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="o">-&gt;</span><span class="n">getV</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=fillLevel_V&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">563</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">addDataAssembly</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="p">);</span>
<span class="linenos">564</span>
<span class="linenos">565</span><span class="w">        </span><span class="c1">// Some parts of the PeaInformationLabel have to be available at runtime</span>
<span class="linenos">566</span>
<span class="linenos">567</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getAssetId</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.AssetId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">568</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getComponentName</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.ComponentName&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">569</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDeviceClass</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.DeviceClass&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">570</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDeviceHealth</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.DeviceHealth&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">571</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDeviceManual</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.DeviceManual&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">572</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDeviceRevision</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.DeviceRevision&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">573</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getHardwareRevision</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.HardwareRevision&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">574</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getManufacturer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.Manufacturer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">575</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getManufacturerUri</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.ManufacturerUri&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">576</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getModel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.Model&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">577</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProductCode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.ProductCode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">578</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getProductInstanceUri</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.ProductInstanceUri&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">579</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getRevisionCounter</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.RevisionCounter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">580</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSerialNumber</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.SerialNumber&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">581</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="o">-&gt;</span><span class="n">getPeaInformation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getSoftwareRevision</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setFixedOpcUaNodeId</span><span class="p">(</span><span class="s">&quot;s=example_mtp_controlengine_PEA.SoftwareRevision&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mtpStaticContentNamespaceName</span><span class="p">);</span>
<span class="linenos">582</span>
<span class="linenos">583</span>
<span class="linenos">584</span>
<span class="linenos">585</span><span class="w">        </span><span class="c1">// Invoke each of our service handlers</span>
<span class="linenos">586</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="p">.</span><span class="n">initializeMtpContents</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mtp</span><span class="p">);</span>
<span class="linenos">587</span><span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Control Engine&#39;s MTP is initialized&quot;</span><span class="p">);</span>
<span class="linenos">588</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">589</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">590</span>
<span class="linenos">591</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">()</span>
<span class="linenos">592</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">593</span><span class="w">        </span><span class="c1">// Update our data assemblies:</span>
<span class="linenos">594</span><span class="w">        </span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">getFillLevelInPercent</span><span class="p">();</span>
<span class="linenos">595</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">596</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">597</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="o">-&gt;</span><span class="n">setQualityCode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">QualityCode</span><span class="o">::</span><span class="n">OUT_OF_SPECIFICATION</span><span class="p">);</span>
<span class="linenos">598</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">599</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">600</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">601</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">fillLevel</span><span class="o">-&gt;</span><span class="n">setQualityCode</span><span class="p">(</span><span class="n">mtp</span><span class="o">::</span><span class="n">QualityCode</span><span class="o">::</span><span class="n">OK</span><span class="p">);</span>
<span class="linenos">602</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">603</span>
<span class="linenos">604</span><span class="w">        </span><span class="c1">// Update each of our services:</span>
<span class="linenos">605</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">liquidService</span><span class="p">.</span><span class="n">update</span><span class="p">();</span>
<span class="linenos">606</span><span class="w">    </span><span class="p">};</span>
<span class="linenos">607</span><span class="p">};</span>
<span class="linenos">608</span>
<span class="linenos">609</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">([[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="p">[[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="linenos">610</span><span class="p">{</span>
<span class="linenos">611</span><span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span><span class="w"> </span><span class="n">stopHandler</span><span class="p">);</span>
<span class="linenos">612</span><span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span><span class="w"> </span><span class="n">stopHandler</span><span class="p">);</span>
<span class="linenos">613</span>
<span class="linenos">614</span><span class="w">    </span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Welcome to our ControlEngine Example&quot;</span><span class="p">);</span>
<span class="linenos">615</span>
<span class="linenos">616</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ProcessController</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span><span class="p">);</span><span class="w"> </span><span class="c1">// ~ 20s till full or empty</span>
<span class="linenos">617</span><span class="w">    </span><span class="n">process</span><span class="o">-&gt;</span><span class="n">doStart</span><span class="p">();</span>
<span class="linenos">618</span>
<span class="linenos">619</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">uaServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">OpcUaServerOpen62541</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">locking</span><span class="o">::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cena</span><span class="o">::</span><span class="n">osal</span><span class="o">::</span><span class="n">locking</span><span class="o">::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">());</span>
<span class="linenos">620</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">controlEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ControlEngine</span><span class="o">&gt;</span><span class="p">(</span><span class="n">uaServer</span><span class="p">,</span><span class="w"> </span><span class="n">process</span><span class="p">);</span>
<span class="linenos">621</span><span class="w">    </span><span class="n">controlEngine</span><span class="o">-&gt;</span><span class="n">doStart</span><span class="p">();</span>
<span class="linenos">622</span>
<span class="linenos">623</span><span class="w">    </span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running the control engine&quot;</span><span class="p">);</span>
<span class="linenos">624</span><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
<span class="linenos">625</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">626</span><span class="w">        </span><span class="n">uaServer</span><span class="o">-&gt;</span><span class="n">doRun</span><span class="p">();</span>
<span class="linenos">627</span><span class="w">        </span><span class="n">controlEngine</span><span class="o">-&gt;</span><span class="n">doRun</span><span class="p">();</span>
<span class="linenos">628</span><span class="w">        </span><span class="n">process</span><span class="o">-&gt;</span><span class="n">doRun</span><span class="p">();</span>
<span class="linenos">629</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
<span class="linenos">630</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">631</span>
<span class="linenos">632</span><span class="w">    </span><span class="n">process</span><span class="o">-&gt;</span><span class="n">doTerminate</span><span class="p">();</span>
<span class="linenos">633</span><span class="w">    </span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Bye-Bye&quot;</span><span class="p">);</span>
<span class="linenos">634</span>
<span class="linenos">635</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">636</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="run_simulation.html" class="btn btn-neutral float-left" title="CENA DEMO: Run the example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../writing_ce_tests.html" class="btn btn-neutral float-right" title="Testing ControlEngines" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Semodia GmbH 2024. All Rights Reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>